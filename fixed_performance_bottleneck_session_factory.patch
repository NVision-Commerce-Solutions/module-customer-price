commit 7a5fc616771618dffe34a98bea3788c39a6dcf1d
Author: artem-lytvynenko-ven <artem@vendic.dev>
Date:   Thu Jan 29 15:34:54 2026 +0200

    Fixed performance bottleneck with SessionFactory->create()

diff --git a/Plugin/Frontend/ProductListPricesPreloadToCache.php b/Plugin/Frontend/ProductListPricesPreloadToCache.php
index 8fe39fc..d682884 100644
--- a/Plugin/Frontend/ProductListPricesPreloadToCache.php
+++ b/Plugin/Frontend/ProductListPricesPreloadToCache.php
@@ -8,7 +8,7 @@ use Commerce365\CustomerPrice\Model\Config;
 use Commerce365\CustomerPrice\Service\GetPriceCollectionForProducts;
 use Commerce365\CustomerPrice\Service\GetProductIdsForRequest;
 use Magento\Catalog\Block\Product\ListProduct;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 
 class ProductListPricesPreloadToCache
 {
@@ -16,7 +16,7 @@ class ProductListPricesPreloadToCache
         private readonly Config $config,
         private readonly GetProductIdsForRequest $getProductIdsForRequest,
         private readonly GetPriceCollectionForProducts $getPriceCollection,
-        private readonly SessionFactory $sessionFactory
+        private readonly Session $session
     ) {}
 
     /**
@@ -26,7 +26,7 @@ class ProductListPricesPreloadToCache
      */
     public function afterGetLoadedProductCollection(ListProduct $subject, $result)
     {
-        $session = $this->sessionFactory->create();
+        $session = $this->session;
         if (!$this->config->isCachingEnabled() || !$session->getCustomerId()) {
             return $result;
         }
diff --git a/Plugin/Frontend/ProductPlugin.php b/Plugin/Frontend/ProductPlugin.php
index d1a853b..bbdb3e7 100644
--- a/Plugin/Frontend/ProductPlugin.php
+++ b/Plugin/Frontend/ProductPlugin.php
@@ -6,20 +6,20 @@ namespace Commerce365\CustomerPrice\Plugin\Frontend;
 
 use Commerce365\CustomerPrice\Model\Config;
 use Magento\Catalog\Model\Product;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 
 class ProductPlugin
 {
     public function __construct(
         private readonly Config $config,
-        private readonly SessionFactory $customerSessionFactory
+        private readonly Session $customerSession
     ) {}
 
     public function afterIsSalable(Product $subject, $result)
     {
         if ($this->config->isAjaxEnabled()
             && $this->config->isHidePricesGuest()
-            && !$this->customerSessionFactory->create()->isLoggedIn()) {
+            && !$this->customerSession->isLoggedIn()) {
             return false;
         }
 
@@ -31,7 +31,7 @@ class ProductPlugin
         if ($key === 'can_show_price'
             && $this->config->isHidePricesGuest()
             && $this->config->isAjaxEnabled()
-            && !$this->customerSessionFactory->create()->isLoggedIn()) {
+            && !$this->customerSession->isLoggedIn()) {
             return false;
         }
 
diff --git a/Plugin/Frontend/TierPricePlugin.php b/Plugin/Frontend/TierPricePlugin.php
index 8253b8c..ebc5008 100644
--- a/Plugin/Frontend/TierPricePlugin.php
+++ b/Plugin/Frontend/TierPricePlugin.php
@@ -6,12 +6,12 @@ namespace Commerce365\CustomerPrice\Plugin\Frontend;
 
 use Commerce365\CustomerPrice\Model\Config;
 use Magento\Catalog\Pricing\Price\TierPrice;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 
 class TierPricePlugin
 {
     public function __construct(
-        private readonly SessionFactory $customerSessionFactory,
+        private readonly Session $customerSession,
         private readonly Config $config
     ) {}
 
@@ -21,7 +21,7 @@ class TierPricePlugin
             return [];
         }
 
-        if (!$this->customerSessionFactory->create()->isLoggedIn() && $this->config->isHidePricesGuest()) {
+        if (!$this->customerSession->isLoggedIn() && $this->config->isHidePricesGuest()) {
             return [];
         }
 
diff --git a/Plugin/ProductPrice.php b/Plugin/ProductPrice.php
index 7d6dca7..ca1c65c 100644
--- a/Plugin/ProductPrice.php
+++ b/Plugin/ProductPrice.php
@@ -12,12 +12,12 @@ use Commerce365\CustomerPrice\Service\GetProductPriceData;
 use Commerce365\CustomerPrice\Service\IsPriceCallAvailable;
 use Magento\Catalog\Model\Product;
 use Magento\Catalog\Model\Product\Type;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 
 class ProductPrice
 {
     public function __construct(
-        private readonly SessionFactory $customerSessionFactory,
+        private readonly Session $customerSession,
         private readonly GetProductPriceData $getProductPriceData,
         private readonly GetMinimalSalableQty $getMinimalSalableQty,
         private readonly GetPriceForQuantity $getPriceForQuantity,
@@ -37,7 +37,7 @@ class ProductPrice
         }
 
         try {
-            $customerId = $this->customerSessionFactory->create()->getCustomerId();
+            $customerId = $this->customerSession->getCustomerId();
 
             $priceData = $this->getProductPriceData->execute($subject->getId(), $customerId);
             if ($this->config->useMinSalableQty()) {
@@ -86,7 +86,7 @@ class ProductPrice
         try {
             $priceData = $this->getProductPriceData->execute(
                 $subject->getId(),
-                $this->customerSessionFactory->create()->getCustomerId()
+                $this->customerSession->getCustomerId()
             );
 
             if (!$priceData->getSpecialPrice()) {
diff --git a/Plugin/SimplePricePlugin.php b/Plugin/SimplePricePlugin.php
index a0c5025..3803048 100644
--- a/Plugin/SimplePricePlugin.php
+++ b/Plugin/SimplePricePlugin.php
@@ -9,12 +9,12 @@ use Commerce365\CustomerPrice\Plugin\Frontend\Product;
 use Commerce365\CustomerPrice\Service\GetPriceForQuantity;
 use Commerce365\CustomerPrice\Service\GetProductPriceData;
 use Magento\Catalog\Model\Product\Type\Price;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 
 class SimplePricePlugin
 {
     public function __construct(
-        private readonly SessionFactory $customerSessionFactory,
+        private readonly Session $customerSession,
         private readonly GetPriceForQuantity $getPriceForQuantity,
         private readonly GetProductPriceData $getProductPriceData,
         private readonly Config $config
@@ -33,7 +33,7 @@ class SimplePricePlugin
             return $result;
         }
 
-        $customerId = $this->customerSessionFactory->create()->getCustomerId();
+        $customerId = $this->customerSession->getCustomerId();
         if (!$customerId) {
             return $result;
         }
diff --git a/Plugin/Webapi/TierPricePlugin.php b/Plugin/Webapi/TierPricePlugin.php
index 46c6b25..98ee170 100644
--- a/Plugin/Webapi/TierPricePlugin.php
+++ b/Plugin/Webapi/TierPricePlugin.php
@@ -10,13 +10,13 @@ use Commerce365\CustomerPrice\Service\GetProductPriceData;
 use Magento\Catalog\Model\Product;
 use Magento\Catalog\Model\Product\Type;
 use Magento\Catalog\Pricing\Price\TierPrice;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 use Magento\Framework\Pricing\Amount\Base;
 
 class TierPricePlugin
 {
     public function __construct(
-        private readonly SessionFactory $customerSessionFactory,
+        private readonly Session $customerSession,
         private readonly GetProductPriceData $getProductPriceData,
         private readonly GetTierPricesPerUom $getTierPricesPerUom,
         private readonly Config $config
@@ -24,7 +24,7 @@ class TierPricePlugin
 
     public function afterGetTierPriceList(TierPrice $subject, $result)
     {
-        $customerId = $this->customerSessionFactory->create()->getCustomerId();
+        $customerId = $this->customerSession->getCustomerId();
         if (!$customerId) {
             return $result;
         }
diff --git a/Service/CurrentCustomer.php b/Service/CurrentCustomer.php
index 792e030..cbc942f 100644
--- a/Service/CurrentCustomer.php
+++ b/Service/CurrentCustomer.php
@@ -4,13 +4,13 @@ declare(strict_types=1);
 
 namespace Commerce365\CustomerPrice\Service;
 
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 
 class CurrentCustomer
 {
     private int $currentCustomerId = 0;
 
-    public function __construct(private readonly SessionFactory $sessionFactory) {}
+    public function __construct(private readonly Session $session) {}
 
     public function setId(string $customerId): void
     {
@@ -24,7 +24,7 @@ class CurrentCustomer
     public function getId(): int
     {
         if (!$this->exists()) {
-            return (int) $this->sessionFactory->create()->getCustomerId();
+            return (int) $this->session->getCustomerId();
         }
 
         return $this->currentCustomerId;
diff --git a/Service/IsPriceCallAvailable.php b/Service/IsPriceCallAvailable.php
index 91c4831..14cbe1b 100644
--- a/Service/IsPriceCallAvailable.php
+++ b/Service/IsPriceCallAvailable.php
@@ -5,18 +5,18 @@ declare(strict_types=1);
 namespace Commerce365\CustomerPrice\Service;
 
 use Commerce365\CustomerPrice\Model\Config;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 
 class IsPriceCallAvailable
 {
     public function __construct(
-        private readonly SessionFactory $customerSessionFactory,
+        private readonly Session $customerSession,
         private readonly Config $config,
     ) {}
 
     public function execute(): bool
     {
-        return $this->customerSessionFactory->create()->isLoggedIn()
+        return $this->customerSession->isLoggedIn()
             && $this->config->isAjaxEnabled();
     }
 }
diff --git a/Service/PriceBox/GetPrice.php b/Service/PriceBox/GetPrice.php
index 7eaa889..73c548a 100644
--- a/Service/PriceBox/GetPrice.php
+++ b/Service/PriceBox/GetPrice.php
@@ -5,14 +5,14 @@ declare(strict_types=1);
 namespace Commerce365\CustomerPrice\Service\PriceBox;
 
 use Commerce365\CustomerPrice\Model\Config;
-use Magento\Customer\Model\SessionFactory;
+use Magento\Customer\Model\Session;
 use Magento\Framework\App\RequestInterface;
 
 class GetPrice
 {
     public function __construct(
         private readonly Config $config,
-        private readonly SessionFactory $customerSessionFactory,
+        private readonly Session $customerSession,
         private readonly RequestInterface $request
     ) {}
 
@@ -22,11 +22,11 @@ class GetPrice
             return $default;
         }
 
-        if (!$this->config->isHidePricesGuest() && !$this->customerSessionFactory->create()->isLoggedIn()) {
+        if (!$this->config->isHidePricesGuest() && !$this->customerSession->isLoggedIn()) {
             return $default;
         }
 
-        if ($this->config->isHidePricesGuest() && !$this->customerSessionFactory->create()->isLoggedIn()) {
+        if ($this->config->isHidePricesGuest() && !$this->customerSession->isLoggedIn()) {
             return '';
         }
 
diff --git a/etc/di.xml b/etc/di.xml
index 6ff6d4b..ad2fb9a 100644
--- a/etc/di.xml
+++ b/etc/di.xml
@@ -83,4 +83,51 @@
             </argument>
         </arguments>
     </type>
+
+    <!-- Session Proxy configuration to avoid early instantiation and repeated DB queries -->
+    <type name="Commerce365\CustomerPrice\Plugin\ProductPrice">
+        <arguments>
+            <argument name="customerSession" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Plugin\SimplePricePlugin">
+        <arguments>
+            <argument name="customerSession" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Service\CurrentCustomer">
+        <arguments>
+            <argument name="session" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Service\IsPriceCallAvailable">
+        <arguments>
+            <argument name="customerSession" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Service\PriceBox\GetPrice">
+        <arguments>
+            <argument name="customerSession" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Plugin\Webapi\TierPricePlugin">
+        <arguments>
+            <argument name="customerSession" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Plugin\Frontend\TierPricePlugin">
+        <arguments>
+            <argument name="customerSession" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Plugin\Frontend\ProductPlugin">
+        <arguments>
+            <argument name="customerSession" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
+    <type name="Commerce365\CustomerPrice\Plugin\Frontend\ProductListPricesPreloadToCache">
+        <arguments>
+            <argument name="session" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
+        </arguments>
+    </type>
 </config>
